<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Between the World and Us—A Think! Contemporary Primary School Virtual Exhibition | Singapore Art Museum</title>
  <link rel="stylesheet" type="text/css" href="./assets/styles/index.css" />
  <script src="./assets/libs/three.min.js"></script>
</head>
<body>
  <div id="container"></div>
  <!-- <div id="backbtn" class="hide">Return</div> -->
  <div class="art-detail hide" id="art_detail">
    <div class="modal-bg"></div>
    <div class="modal-content">
      <div class="back_btn" id="backbtn"></div>
      <div class="content-box">
        <div class="art-detail-left">
          <div class="art-detail-left-tit">OUR WONDERFUL, FANTASTIC ECLECTIC</div>
          <div class="art-detail-left-desc">Our Wonderful, Fantastic Eclectic is a series of fantastical headpieces inspired by the world around us, from the wonders of our local food and culture to the COVID-19 pandemic.</div>
        </div>
        <div class="art-detail-right">
          <div class="art-detail-right-img"></div>
          <div class="art-detail-right-desc">Our Wonderful, Fantastic Eclectic is a series of fantastical headpieces inspired by the world around us, from the wonders of our local food and culture to the COVID-19 pandemic.</div>
        </div>
      </div>
    </div>
  </div>
  <video id="memories0" playsinline webkit-playsinline muted loop autoplay width="1290" height="1040" src="./assets/video/memories-0.mp4" style="display:none;"></video>
  <script type="text/javascript">
    var camera, scene, renderer, light;
    var raycaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();
    var isUserInteracting = false, onMouseDownMouseX = 0, onMouseDownMouseY = 0, lon = 90, onMouseDownLon = 0, lat = 0, onMouseDownLat = 0, phi = 0, theta = 0;
    // 球体网格
    var geometry;
    // 四个全景图
    var people_room, room1_side, room2_side,room3_side,room4_side;
    // 全景球体对象
    var mesh;
    // 摄像机移动参数
    var canvas_step;
    var camera_time = 0;
    var interactMeshes = [];
    var anchorMeshes = [];
    var useTarget = true;
    var activeRotate = 0;
    var stories_room_text_tips = [];//room1 finished
    var spaces_room_text_tips = [];//room2 finished
    var people_room_text_tips = [];//room3 finished
    var hope_room_text_tips = [];//room4 finished

    var target_lon;

    var art_detail = document.getElementById("art_detail");

    var backbtn = document.getElementById("backbtn");
    console.log("backbtn",backbtn);

    backbtn.addEventListener("click",()=>{
      camera_time = 0;
      camera.fov = 75;
      useTarget = true;
      art_detail.classList.add("hide");
    })
    // function hideModal(){
    //   art_detail.classList.add("hide");
    // }

    init();
    animate();
    playVideo();
    function sphereBackground(imageSource){
      let backgroundImage = new THREE.TextureLoader().load(imageSource);
      backgroundImage.mapping = THREE.EquirectangularReflectionMapping;
      backgroundMap = new THREE.MeshBasicMaterial({map: backgroundImage});
      return backgroundMap;
    }
    function init() {
      var container;
      container = document.getElementById('container');
      // 摄像机
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1100);
      camera.target = new THREE.Vector3(0, 0, 0);
      scene = new THREE.Scene();
      // 添加灯光
      light = new THREE.HemisphereLight(0xffffff);
      light.position.set(0, 40, 0);
      scene.add(light);
      light = new THREE.DirectionalLight(0xffffff);
      light.position.set(0, 40, -10);
      scene.add(light);
      // 全景场景
      geometry = new THREE.SphereGeometry(700, 60, 60);
      //geometry = new THREE.SphereGeometry(700, 60, 80, Math.PI / 2.9);
      // 按z轴翻转
      geometry.scale(1, 1, -1);
      // 添加贴图
      room1_side = sphereBackground('./assets/images/room-1.jpg');
      // room1_side = new THREE.MeshBasicMaterial({
      //   //文小芳
      //   map: new THREE.TextureLoader().load('./assets/images/room-1.jpg')
      // });
      room2_side = new THREE.MeshBasicMaterial({
        map: new THREE.TextureLoader().load('./assets/images/room-2.jpg')
      });
      room3_side = new THREE.MeshBasicMaterial({
        map: new THREE.TextureLoader().load('./assets/images/room-3.jpg')
      });
      room4_side = new THREE.MeshBasicMaterial({
        map: new THREE.TextureLoader().load('./assets/images/room-4.jpg')
      });
      mesh = new THREE.Mesh(geometry, room1_side);
      loadMarker('stories');
      scene.add(mesh);
      renderer = new THREE.WebGLRenderer({
        antialias: true, // 模型抗锯齿
        alpha: true // 开启背景透明
      });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      container.appendChild(renderer.domElement);
      document.addEventListener('mousedown', onDocumentMouseDown, false);
      document.addEventListener('mousemove', onDocumentMouseMove, false);
      document.addEventListener('mouseup', onDocumentMouseUp, false);
      document.addEventListener('touchstart', onDocumentTouchDown, false);
      document.addEventListener('touchmove', onDocumentTouchMove, false);
      document.addEventListener('touchend', onDocumentMouseUp, false);
      window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // 鼠标控制
    function onDocumentMouseDown(event) {
      console.log("target_lon",lon);
      // if(camera.fov!=90){
      //   console.log("useTarget",useTarget);
      //   useTarget = true;
      //   camera.fov = 90;
      //   camera.updateProjectionMatrix();
      // }
      // if(useTarget == false){
      //   useTarget = true;
      // }
      raycaster.setFromCamera(mouse, camera);
      var intersects = raycaster.intersectObjects(interactMeshes);
      // console.log("intersects===",intersects);
      if(intersects.length > 0){
        let name = intersects[0].object.name;
        // console.log("name===",name);
        if(name=='stories_people_text'){
          // useTarget = false;
          camera_time = 1;
          canvas_step = 'stories_people';
        }
        else if(name=='stories_spaces_text'){
          // useTarget = true;
          camera_time = 1;
          canvas_step = 'stories_spaces';
        }
        else if(name=='people_stories_text'){
          // useTarget = true;
          camera_time = 1;
          canvas_step = 'people_stories';
        }
        else if(name=='people_hope_text'){
          // useTarget = true;
          camera_time = 1;
          canvas_step = 'people_hope';
        }
        else if(name=='spaces_hope_text'){
          // useTarget = true;
          camera_time = 1;
          canvas_step = 'spaces_hope';
        }
        else if(name=='spaces_stories_text'){
          // useTarget = true;
          camera_time = 1;
          canvas_step = 'spaces_stories';
        }
        else if(name=='hope_people_text'){
          // useTarget = true;
          camera_time = 1;
          canvas_step = 'hope_people';
        }
        else if(name=='hope_spaces_text'){
          // useTarget = true;
          camera_time = 1;
          canvas_step = 'hope_spaces';
        }
        else if(name=='icon_search'){
          canvas_step = 'art_detail';
          camera_time = 0;
          // camera.fov = 75;
          useTarget = false;
          // camera.updateProjectionMatrix();
          art_detail.classList.remove("hide");
      // if(camera.fov!=90){
      //   console.log("useTarget",useTarget);
      //   useTarget = true;
      //   camera.fov = 90;
      //   camera.updateProjectionMatrix();
      // }
        }
        else if (name.indexOf('between_the_world_and_us'>-1)){
          canvas_step = 'detail_text';
          if(name=='between_the_world_and_us1'){
            target_lon = 90;
          }
          else if(name=='between_the_world_and_us2'){
            target_lon = 270;
          }
          else if(name=='between_the_world_and_us3'){
            if(lon<0){
              target_lon = 360;
            }
            else{
              target_lon = 0;
            }
          }
          else if(name=='between_the_world_and_us4'){
            target_lon = 180;
          }
          if(lon<0){
            lon = 360+lon;
          }
          let interval = (target_lon - lon)/10;
          //console.log("interval",interval);
          let tmp_timer = setInterval(()=>{
            if(lon == target_lon){
              clearInterval(tmp_timer);
              camera_time = 1;
              // useTarget = false;
            }
            else{
              if(interval>0&&lon>target_lon){
                if(lon - interval<target_lon){
                  lon = target_lon
                }
                else{
                  lon = lon - interval;
                }
              }
              else if(interval>0&&lon<target_lon){
                if(lon + interval>target_lon){
                  lon = target_lon;
                }
                else{
                  lon = lon + interval;
                }
              }
              else if(interval<0&&lon>target_lon){
                if(lon + interval<target_lon){
                  lon = target_lon
                }
                else{
                  lon = lon + interval;
                }
              }
              else if(interval<0&&lon<target_lon){
                if(lon - interval>target_lon){
                  lon = target_lon
                }
                else{
                  lon = lon - interval;
                }
              }
            }
          },100);
        }
        // else if(name=='between_the_world_and_us1'){
        //   canvas_step = 'detail_text';
        //   console.log("lon---",lon);
        //   // lon = Math.ceil(lon);
        //   let interval = (90 - lon)/10;
        //   //console.log("interval",interval);
        //   let tmp_timer = setInterval(()=>{
        //     if(lon == 90){
        //       clearInterval(tmp_timer);
        //       camera_time = 1;
        //       // useTarget = false;
        //     }
        //     else{
        //       if(interval>0&&lon>90){
        //         if(lon - interval<90){
        //           lon = 90
        //         }
        //         else{
        //           lon = lon - interval;
        //         }
        //       }
        //       else if(interval>0&&lon<90){
        //         if(lon + interval>90){
        //           lon = 90;
        //         }
        //         else{
        //           lon = lon + interval;
        //         }
        //       }
        //       else if(interval<0&&lon>90){
        //         if(lon + interval<90){
        //           lon = 90
        //         }
        //         else{
        //           lon = lon + interval;
        //         }
        //       }
        //       else if(interval<0&&lon<90){
        //         if(lon - interval>90){
        //           lon = 90
        //         }
        //         else{
        //           lon = lon - interval;
        //         }
        //       }
        //     }
        //   },100);
        //   //camera_time = 1;
        // }
      }
      isUserInteracting = true;
      onPointerDownPointerX = event.clientX;
      onPointerDownPointerY = event.clientY;
      onPointerDownLon = lon;
      onPointerDownLat = lat;
    }

    function onDocumentTouchDown(event) {
      isUserInteracting = true;
      onPointerDownPointerX = event.touches[0].pageX;
      onPointerDownPointerY = event.touches[0].pageY;
      onPointerDownLon = lon;
      onPointerDownLat = lat;
    }

    function onDocumentMouseMove(event) {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
      if (isUserInteracting === true) {
        lon = (onPointerDownPointerX - event.clientX) * 0.1 + onPointerDownLon;
        lat = (event.clientY - onPointerDownPointerY) * 0.1 + onPointerDownLat;
      }
      let tmplon = ((lon-90)%360)/180;
      // console.log("tmplon",tmplon);
      activeRotate = Math.PI*tmplon;//Math.PI 180deg

      for (let i = scene.children.length - 1; i >= 0; i--) {
        if(scene.children[i].name&&scene.children[i].name=='between_the_world_and_us1'){
          //console.log("scene.children[i]",scene.children[i]);
          scene.children[i].material.rotation = activeRotate;
        }
      }
    }

    function onDocumentTouchMove(event) {
      if (isUserInteracting === true) {
        lon = (onPointerDownPointerX - event.touches[0].pageX) * 0.1 + onPointerDownLon;
        lat = (event.touches[0].pageY - onPointerDownPointerY) * 0.1 + onPointerDownLat;
      }
    }

    function onDocumentMouseUp(event) {
      isUserInteracting = false;
    }

    function onDocumentMouseWheel(event) {
      // camera.fov += event.deltaY * 0.05;
      // camera.updateProjectionMatrix();
    }

    function animate() {
      requestAnimationFrame(animate);
      update();
      anchorMeshes.map(item => {
        item.rotation.y += 0.02;
      });
    }

    //捕捉鼠标
    function update() {
      console.log("lon",lon);
      lon = Math.ceil(lon);
      // console.log("useTarget===",useTarget);
      // console.log("camera_time",camera_time);
      // console.log("camera.fov",camera.fov);
      if(camera_time==0&&camera.fov==75&&useTarget){
        lat = Math.max(- 85, Math.min(85, lat));
        phi = THREE.Math.degToRad(90 - lat);
        theta = THREE.Math.degToRad(lon);
        camera.target.x = 700 * Math.sin(phi) * Math.cos(theta);
        camera.target.y = 700 * Math.cos(phi);
        camera.target.z = 700 * Math.sin(phi) * Math.sin(theta);
      }
      if (camera_time > 0 && camera_time < 30) {
        if(canvas_step=='detail_text'){
          //console.log("mesh.position",mesh.position);
          // mesh.position.y = -160;
          // mesh.position.z = -160;

          let tmp_timer = setInterval(()=>{
            if(mesh.position.z == -100){
              // loadMarker('people');
              clearInterval(tmp_timer);
            }
            else{
              mesh.position.z = mesh.position.z - 10;
            }
          },100);

          // mesh.material
          // camera.target.z = 0;
          // console.log("lon",lon);
          // camera.target.x = 4;
          // camera.target.y = 0;
          // camera.target.z = 500;
          // console.log("camera.target",camera.target);
        }
        //camera.fov -= 1;
        // lat = 0;
        // let tmp_timer = setInterval(()=>{
        //   if(mesh.position.z == 0){
        //     clearInterval(tmp_timer);
        //   }
        //   else{
        //     mesh.position.z = mesh.position.z + 30;
        //     lon = lon - 1;
        //   }
        // },100);
        camera.updateProjectionMatrix();
        camera_time++;
      } else if (camera_time === 30) {
        camera_time = 0;
        if(canvas_step!='detail_text'){
          camera_time = 0;
          camera.fov = 75;
          camera.updateProjectionMatrix();
        }
        else{
          //backbtn.classList.remove('hide');
        }
        if(canvas_step=='stories_people'){
          // room3_side.map.center = new THREE.Vector2(1,1);
          // room3_side.map.offset = new THREE.Vector2(10,0);
          // room3_side.rotation = new THREE.Vector3(-30,-30,-30);
          
          mesh.material = room3_side;
          // mesh.position.set(0,0,-200);
          // mesh.position.set(0,0,-1);
          mesh.position.x = 100;
          // mesh.position.z = -450;
          mesh.position.z = -400;
          console.log("mesh",mesh);
          // loadMarker('people');
          //这里改变 camera.target 无效 因为上面会修改过来
          lon = -102;
          // lat = 0;
          // let tmp_timer = setInterval(()=>{
          //   if(mesh.position.z == 0){
          //     clearInterval(tmp_timer);
          //   }
          //   else{
          //     mesh.position.z = mesh.position.z + 30;
          //     lon = lon - 1;
          //   }
          // },100);
        }
        else if(canvas_step=='stories_spaces'){
          mesh.material = room2_side;
          loadMarker('spaces');
        }
        else if(canvas_step=='people_stories'){
          mesh.material = room1_side;
          loadMarker('stories');
        }
        else if(canvas_step == 'people_hope'){
          mesh.material = room4_side;
          loadMarker('hope');
        }
        else if(canvas_step=='spaces_hope'){
          mesh.material = room4_side;
          loadMarker('hope');
        }
        else if(canvas_step=='spaces_stories'){
          mesh.material = room1_side;
          loadMarker('stories');
        }
        else if(canvas_step=='hope_people'){
          mesh.material = room3_side;
          loadMarker('people');
        }
        else if(canvas_step=='hope_spaces'){
          mesh.material = room2_side;
          loadMarker('spaces');
        }
        camera.updateProjectionMatrix();
      }
      // console.log("camera.target",camera.target);
      camera.lookAt(camera.target);
      renderer.render(scene, camera);
    }

    // 加载交互点
    function loadMarker(type) {
      var interactPoints = [
        { name: 'stories_people_text',type:'stories', scale:16, x: 44, y:1, z: -20 },
        { name: 'stories_spaces_text',type:'stories', scale:9, x: -21, y:1, z: -20 },
        { name: 'between_the_world_and_us1',type:'stories', scale: 2, x: 0, y:-16, z: 20,rotate:{x:0,y:0,z:0} },
        { name: 'between_the_world_and_us2',type:'stories', scale: 2, x: 0, y:-16, z: -20,rotate:{x:0,y:0,z:0} },
        { name: 'between_the_world_and_us3',type:'stories', scale: 2, x: 20, y:-20, z:0,rotate:{x:0 - Math.PI/2,y:Math.PI / 2,z:Math.PI / 2} },
        { name: 'between_the_world_and_us4',type:'stories', scale: 2, x: -30, y:-16, z:0,rotate:{x:0 - Math.PI/2,y:Math.PI / 2,z:Math.PI / 2} },
        { name: 'icon_search',type:'stories', scale: 4, x: 50, y: -12, z: 40 },
        // { name: 'people_stories_text',type:'people', scale: 10, x: -21, y: 1, z: 20 },
        // { name: 'people_hope_text',type:'people', scale: 6, x: -6, y: 0, z: 20 },
        { name: 'people_stories_text',type:'people', scale: 6, x: -6, y: 0, z: 20 },
        { name: 'people_hope_text',type:'people',scale: 10, x: -21, y: 1, z: 20 },
        { name: 'spaces_stories_text',type:'spaces', scale:6, x: -7, y:1, z: -20 },
        { name: 'spaces_hope_text',type:'spaces', scale:16, x:-36, y:1, z:20 },
        { name: 'hope_people_text',type:'hope', scale: 10, x: -18, y: 1, z: 20 },
        { name: 'hope_spaces_text',type:'hope',scale:6, x: 2, y:1, z: -20 }
      ];
      //文小芳
      interactPoints = interactPoints.filter(item => item.type.includes(type));
      var nameArr = [];
      interactPoints.map((item)=>{
        nameArr.push(item.name);
      })
      // 移除marker
      for (let i = scene.children.length - 1; i >= 0; i--) {
        // console.log('scene.children[i].name',scene.children[i].name);
        if(scene.children[i].name&&nameArr.indexOf(scene.children[i].name)==-1){
          scene.remove(scene.children[i]);
        }
      }
      // 添加问号标记点
      var pointTexture;
      interactPoints.map(item => {
        if(item.name=='stories_people_text'){
          pointTexture = new THREE.TextureLoader().load('./assets/images/icon-text-people.png');
        }
        else if(item.name=='stories_spaces_text'){
          pointTexture = new THREE.TextureLoader().load('./assets/images/icon-text-spaces.png');
        }
        else if(item.name=='people_stories_text'){
          pointTexture = new THREE.TextureLoader().load('./assets/images/icon-text-stories.png');
        }
        else if(item.name=='people_hope_text'){
          pointTexture = new THREE.TextureLoader().load('./assets/images/icon-text-hope.png');
        }
        else if(item.name=='spaces_stories_text'){
          pointTexture = new THREE.TextureLoader().load('./assets/images/icon-text-stories.png');
        }
        else if(item.name=='spaces_hope_text'){
          pointTexture = new THREE.TextureLoader().load('./assets/images/icon-text-hope.png');
        }
        else if(item.name=='hope_people_text'){
          pointTexture = new THREE.TextureLoader().load('./assets/images/icon-text-people.png');
        }
        else if(item.name=='hope_spaces_text'){
          pointTexture = new THREE.TextureLoader().load('./assets/images/icon-text-spaces.png');
        }
        else if(item.name=='icon_search'){
          pointTexture = new THREE.TextureLoader().load('./assets/images/icon-search.png');
        }
        else{
          pointTexture = new THREE.TextureLoader().load('./assets/images/icon-zoom.png');
        }
        var pointMaterial = new THREE.SpriteMaterial({ map: pointTexture });
        var point = new THREE.Sprite(pointMaterial);
        // if(item.name.indexOf('between_the_world_and_us')>-1||item.name=='icon_search'){
        //   pointMaterial = new THREE.MeshBasicMaterial({ map: pointTexture,side: THREE.DoubleSide, transparent: true});
        //   point = new THREE.Mesh(
        //     new THREE.PlaneGeometry(1,1),
        //     pointMaterial
        //   );
        // }
        if(item.name.indexOf('between_the_world_and_us')>-1){
          pointMaterial = new THREE.MeshBasicMaterial({ map: pointTexture,side: THREE.DoubleSide, transparent: true});
          point = new THREE.Mesh(
            new THREE.PlaneGeometry(1,1),
            pointMaterial
          );
        }
        // if(item.name=='between_the_world_and_us1'||item.name=='between_the_world_and_us2'){
        //   pointMaterial = new THREE.MeshBasicMaterial({ map: pointTexture,side: THREE.DoubleSide, transparent: true});
        //   point = new THREE.Mesh(
        //     new THREE.PlaneGeometry(1,1),
        //     pointMaterial
        //   );
        // }
        // if(item.name=='between_the_world_and_us3'||item.name=='between_the_world_and_us4'){
        //   pointMaterial = new THREE.MeshBasicMaterial({ map: pointTexture,side: THREE.FrontSide, transparent: true});
        //   point = new THREE.Mesh(
        //     new THREE.PlaneGeometry(1,1),
        //     pointMaterial
        //   );
        // }
        point.name = item.name;
        //
        //console.log(mesh.position);
        // let tmpZ = item.z-(mesh.position.z/350)*item.z;
        // tmpZ = item.z;
        // console.log(tmpZ);
        point.scale.set(item.scale, item.scale, item.scale);
        point.position.set(item.x, item.y,item.z);
        if(item.rotate&&item.rotate.x){
          point.rotateX(item.rotate.x);
        }
        if(item.rotate&&item.rotate.y){
          point.rotateY(item.rotate.y);
        }
        if(item.rotate&&item.rotate.z){
          point.rotateZ(item.rotate.z);
        }
        interactMeshes.push(point);
        scene.add(point);
      });
    }

    //放置视频
    function playVideo(){
      document.getElementById('memories0').play();
      var memoriesVidoSrc = document.getElementById("memories0");
      const memoriesVidMap = new THREE.VideoTexture(memoriesVidoSrc);
      memoriesVidMap.minFilter = THREE.LinearFilter;
      memoriesVidMap.magFilter = THREE.LinearFilter;
      const memoriesVideo = artworkCloner(20, 11, memoriesVidMap);
      // memoriesVideo.rotateY(Math.PI * 0.6);
      memoriesVideo.position.set(-12.8, -4, 40);
      memoriesVideo.scale.set(0.76,0.8,0.8);
      memoriesVideo.name = "memoriesVideo";
      scene.add(memoriesVideo)
    }

    //Function used to create a artwork plane
    function artworkCloner(scale1, scale2, mapMaterial){
        var customPlane = new THREE.Mesh(
          new THREE.PlaneGeometry(scale1, scale2),
          new THREE.MeshBasicMaterial({ map: mapMaterial, side: THREE.DoubleSide, color: 0xff0000, transparent: true, opacity: 0.8})
        );
        return customPlane;
      }
  </script>
</body>
</html>